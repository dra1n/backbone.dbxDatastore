(function(){"use strict";!function(a,b){var c,d;return"undefined"!=typeof exports&&null!==exports?(d=require("underscore"),c=require("backbone"),module.exports=b(d,c)):("undefined"!=typeof define&&null!==define?define.amd:void 0)?define(["underscore","backbone"],function(c,d){return b(c||a._,d||a.Backbone)}):b(a._,a.Backbone)}(this,function(a,b){return b.DbxDatastore=function(){function c(a){this.tableName=a,this.datastoreDfr=b.DbxDatastore.datastore}return c.prototype.create=function(a){return this._withDatastore(function(b){return function(c){var d;return d=b._getTable(c).insert(a.toJSON()),a.id=d.getId(),a.set(a.idAttribute,a.id),b.jsonData(b._getRecord(c,a))}}(this))},c.prototype.update=function(a){return this._withDatastore(function(b){return function(c){return b._getRecord(c,a).update(a.toJSON()),b.jsonData(b._getRecord(c,a))}}(this))},c.prototype.find=function(a){return this._withDatastore(function(b){return function(c){return b.jsonData(b._getRecord(c,a))}}(this))},c.prototype.findAll=function(b){return null==b&&(b={}),this._withDatastore(function(c){return function(d){return a(c._getTable(d).query(b)).map(function(a){return c.jsonData(a)})}}(this))},c.prototype.destroy=function(a){return a.isNew()?!1:this._withDatastore(function(b){return function(c){return b._getRecord(c,a).deleteRecord(),a}}(this))},c.prototype.jsonData=function(a){var b;return null!=a&&(b=this._convertList(a.getFields()),b.id=a.getId()),b},c.prototype._withDatastore=function(a){return this.datastoreDfr.then(a)},c.prototype._getRecord=function(a,b){return this._getTable(a).get(b.id)},c.prototype._getTable=function(a){return this._table||(this._table=a.getTable(this.tableName))},c.prototype._convertList=function(b){return a(b).each(function(a,c){return a instanceof Dropbox.Datastore.List?b[c]=a.toArray():void 0}),b},c.sync=function(a,c,d){var e,f,g,h,i;h=c.dbxDatastore||c.collection.DbxDatastore,i=b.$.Deferred&&b.$.Deferred();try{switch(a){case"read":g=null!=c.id?h.find(c):h.findAll(d.data);break;case"create":g=h.create(c);break;case"update":g=h.update(c);break;case"delete":g=h.destroy(c)}}catch(j){e=j,f=e.message}return g.done(function(a){return(null!=d?d.success:void 0)&&("0.9.10"===b.VERSION?d.success(c,a,d):d.success(a)),null!=i?i.resolve(a):void 0}),g.fail(function(){return f=null!=f?f:"Record Not Found",(null!=d?d.error:void 0)&&("0.9.10"===b.VERSION?d.error(c,f,d):d.error(f)),null!=i?i.reject(f):void 0}),g.always(function(a){return(null!=d?d.complete:void 0)?d.complete(a):void 0}),null!=i?i.promise():void 0},c.datastore=b.$.Deferred(),c}(),b.ajaxSync=b.sync,b.getSyncMethod=function(a){var c;return a.dbxDatastore||(null!=(c=a.collection)?c.dbxDatastore:void 0)?b.DbxDatastore.sync:b.ajaxSync},b.sync=function(a,c,d){return b.getSyncMethod(c).apply(this,[a,c,d])},b.DbxDatastore})}).call(this);